---
title: API Request Flow with OAuth 2.0 (API Consumer)
---

sequenceDiagram
    autonumber
    
    participant App as ğŸ“± API Consumer App<br/>(Corporate Zone)
    participant OpenAM as ğŸ” OpenAM SSO<br/>(Inner DMZ)
    participant GW as âš¡ API Gateway<br/>(Core Zone)
    participant Redis as âš¡ Redis<br/>(Core Zone)
    participant Backend as ğŸ”§ Backend API<br/>(Core Zone)
    participant ES as ğŸ“ˆ Elasticsearch<br/>(Core Zone)
    
    Note over App,ES: API REQUEST WITH OAuth 2.0 TOKEN FLOW
    
    rect rgb(255, 243, 224)
        Note over App,OpenAM: STEP 1: Get Access Token (Client Credentials)
        
        App->>OpenAM: 1ï¸âƒ£ POST /oauth2/token<br/>grant_type=client_credentials&<br/>client_id=my-app&<br/>client_secret=xxx&<br/>scope=api:read api:write
        
        OpenAM->>OpenAM: 2ï¸âƒ£ Validate client credentials
        
        OpenAM-->>App: 3ï¸âƒ£ Token Response<br/>{<br/>  "access_token": "eyJhbGc...",<br/>  "token_type": "Bearer",<br/>  "expires_in": 3600,<br/>  "scope": "api:read api:write"<br/>}
    end
    
    rect rgb(232, 245, 233)
        Note over App,Backend: STEP 2: Call API with Bearer Token
        
        App->>GW: 4ï¸âƒ£ POST /api/v1/users<br/>Authorization: Bearer eyJhbGc...<br/>Content-Type: application/json<br/>{"name": "John"}
    end
    
    rect rgb(255, 235, 238)
        Note over GW,OpenAM: STEP 3: Validate Token
        
        alt Token Introspection
            GW->>OpenAM: 5ï¸âƒ£a POST /oauth2/introspect<br/>token=eyJhbGc...
            OpenAM-->>GW: 6ï¸âƒ£a {<br/>  "active": true,<br/>  "client_id": "my-app",<br/>  "scope": "api:read api:write"<br/>}
        else JWKS Validation (Cached)
            GW->>OpenAM: 5ï¸âƒ£b GET /oauth2/jwks (cached)
            OpenAM-->>GW: 6ï¸âƒ£b {keys: [...]}
            GW->>GW: Validate JWT signature locally
        end
    end
    
    rect rgb(227, 242, 253)
        Note over GW,Redis: STEP 4: Rate Limiting
        
        GW->>Redis: 7ï¸âƒ£ INCR rate:my-app:users-api
        Redis-->>GW: 8ï¸âƒ£ Count: 50/1000 âœ…
    end
    
    rect rgb(243, 229, 245)
        Note over GW,Backend: STEP 5: Route to Backend
        
        GW->>GW: 9ï¸âƒ£ Apply policies<br/>â€¢ Add X-Correlation-ID<br/>â€¢ Transform request
        
        GW->>Backend: ğŸ”Ÿ POST /users<br/>X-Correlation-ID: uuid<br/>X-Consumer-Id: my-app
        
        Backend->>Backend: 1ï¸âƒ£1ï¸âƒ£ Process request
        
        Backend-->>GW: 1ï¸âƒ£2ï¸âƒ£ 201 Created<br/>{"id": "user-123", "name": "John"}
    end
    
    rect rgb(255, 253, 231)
        Note over GW,ES: STEP 6: Analytics & Response
        
        GW-)ES: 1ï¸âƒ£3ï¸âƒ£ Push analytics (async)<br/>{api, consumer, latency, status}
        
        GW-->>App: 1ï¸âƒ£4ï¸âƒ£ 201 Created<br/>{"id": "user-123", "name": "John"}
    end
    
    Note over App,ES: âœ… API call completed successfully
